# サーバーロック状態のクリーンアップ

## 問題
監視スクリプトで「他のサーバーで実行中」と表示される問題が発生した。

## 原因
- データベースに古いクロール状態（`crawlStatus.isRunning = true`）が残っていた
- 監視スクリプトが異常終了した際に、ロック状態が適切にクリーンアップされていなかった

## 対策
1. **自動クリーンアップ機能の追加**
   - 監視実行時に30分以上前の古いロック状態を自動的にクリーンアップ
   - `cleanupStaleLocks()` メソッドを実装

2. **グレースフルシャットダウンの改善**
   - 監視停止時にそのサーバーのロック状態をクリーンアップ
   - `stop()` メソッドを非同期化し、適切なクリーンアップを実行

3. **手動リセットスクリプト**
   - `scripts/reset-crawl-status.ts` で手動リセットが可能

## 実装詳細
- `scripts/observe-store.ts` に `cleanupStaleLocks()` メソッドを追加
- 30分以上前の `startedAt` を持つロック状態を自動クリーンアップ
- 監視停止時に `serverId` が一致するロック状態をクリーンアップ

## 今後の注意点
- 監視スクリプトの異常終了時は必ずロック状態を確認する
- 定期的に `scripts/reset-crawl-status.ts` を実行してロック状態を確認する
- サーバーIDの管理を適切に行う（環境変数 `SERVER_ID` の設定）
